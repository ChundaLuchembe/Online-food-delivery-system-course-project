<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Order Confirmation - Food Delivery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-yellow-200 to-yellow-50 min-h-screen d-flex align-items-center justify-content-center">
  <div class="container max-w-lg bg-white rounded-3xl shadow-lg p-5 mt-5">
    <h2 class="text-center text-2xl font-bold mb-4 text-yellow-600">Order Confirmation</h2>
    <div id="order-summary" class="mb-4">
      <!-- Cart summary will be rendered here -->
    </div>
    <form id="paymentForm">
      <div class="mb-3">
        <label class="form-label">Choose Payment Method</label>
        <select class="form-select" id="paymentType" required>
          <option value="">Select payment type</option>
          <option value="card">Card</option>
          <option value="mtn">MTN Mobile Money</option>
          <option value="airtel">Airtel Money</option>
          <option value="zamtel">Zamtel Money</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Delivery Address</label>
        <textarea class="form-control" id="deliveryAddress" rows="3" placeholder="Enter your complete delivery address" required></textarea>
      </div>
      <div id="payment-details" class="mb-3"></div>
      <button type="submit" class="btn btn-warning w-100 mb-2">Confirm Order</button>
      <button type="button" class="btn btn-outline-danger w-100" onclick="cancelOrder()">Cancel Order</button>
    </form>
    <div id="order-success" class="alert alert-success mt-3 d-none text-center"></div>
  </div>
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      alert('You must be logged in to access the order page.');
      window.location.href = 'login.html';
    }

    // Load cart from localStorage/sessionStorage or use a global variable if available
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function renderOrderSummary() {
      if (cart.length === 0) {
        document.getElementById('order-summary').innerHTML = '<p>Your cart is empty.</p>';
        document.getElementById('paymentForm').style.display = 'none';
        return;
      }
      let html = '<ul class="list-group mb-3">';
      cart.forEach(item => {
        html += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${item.name} (x${item.qty})</span>
            <span>ZMW ${(item.price * item.qty).toFixed(2)}</span>
          </li>
        `;
      });
      html += '</ul>';
      html += `<div class="fw-bold text-end">Total: ZMW ${cart.reduce((sum, i) => sum + i.price * i.qty, 0).toFixed(2)}</div>`;
      document.getElementById('order-summary').innerHTML = html;
    }

    // Payment details form
    document.getElementById('paymentType').addEventListener('change', function() {
      const type = this.value;
      let html = '';
      if (type === 'card') {
        html = `
          <input type="text" class="form-control mb-2" placeholder="Card Number" required>
          <input type="text" class="form-control mb-2" placeholder="Cardholder Name" required>
          <input type="text" class="form-control mb-2" placeholder="Expiry (MM/YY)" required>
          <input type="text" class="form-control mb-2" placeholder="CVV" required>
        `;
      } else if (type === 'mtn' || type === 'airtel' || type === 'zamtel') {
        html = `
          <input type="text" class="form-control mb-2" placeholder="Mobile Number" required>
        `;
      }
      document.getElementById('payment-details').innerHTML = html;
    });

    // Handle order confirmation
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Get existing orders or initialize an empty array
      let orders = JSON.parse(localStorage.getItem('orders')) || [];

      // Create the new order object
      const newOrder = {
        customer: localStorage.getItem('userEmail') || 'Guest',
        items: cart,
        total: cart.reduce((sum, i) => sum + i.price * i.qty, 0).toFixed(2),
        paymentType: document.getElementById('paymentType').value,
        status: 'Pending',
        deliveryAddress: document.getElementById('deliveryAddress').value
      };

      // Add the new order to the array
      orders.push(newOrder);

      // Save back to localStorage
      localStorage.setItem('orders', JSON.stringify(orders));

      // Show thank you, clear cart, redirect, etc.
      document.getElementById('order-success').textContent = 'Order placed successfully! Thank you for choosing us.';
      document.getElementById('order-success').classList.remove('d-none');
      localStorage.removeItem('cart');
      cart = [];
      renderOrderSummary();
      this.reset();
      document.getElementById('payment-details').innerHTML = '';
      setTimeout(function() {
        window.location.href = 'home.html';
      }, 2000);
    });

    function cancelOrder() {
      alert('Order canceled. Proceed to shopping.');
      window.location.href = 'home.html';
    }

    // On page load
    renderOrderSummary();
  </script>
</body>
</html>
